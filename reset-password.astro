---
// No props needed - this is a standalone page
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password • PoCo</title>
  <meta name="robots" content="noindex,nofollow">
  
  <style>
    :root {
      --brand: #10b981;
      --brand-600: #059669;
      --brand-700: #047857;
      --ink: #111827;
      --muted: #6b7280;
      --bg: #ffffff;
      --border: #e5e7eb;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Arial, sans-serif;
      background: #f9fafb;
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .wrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .container {
      width: 100%;
      max-width: 480px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 48px 40px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    h1 {
      color: var(--ink);
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: 600;
      text-align: center;
      letter-spacing: -0.025em;
    }
    
    .lead {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 32px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      color: var(--ink);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    input[type="password"],
    input[type="email"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      background: #fff;
      transition: all 0.2s;
      color: var(--ink);
    }
    
    input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    input::placeholder {
      color: #9ca3af;
    }
    
    .note {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.4;
    }
    
    .requirements {
      margin-top: 10px;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 13px;
      border: 1px solid #f3f4f6;
    }
    
    .requirement {
      color: #9ca3af;
      margin: 6px 0;
      transition: color 0.2s;
      font-size: 12px;
    }
    
    .requirement.met {
      color: var(--brand);
      font-weight: 500;
    }
    
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    
    .button {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-primary {
      background: var(--brand);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--brand-700);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    
    .btn-ghost:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    
    .msg {
      margin-top: 20px;
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .msg.ok {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      color: #065f46;
    }
    
    .msg.err {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    
    .success-banner {
      animation: fadein 0.5s ease-out forwards;
      text-align: center;
      padding: 24px 20px;
      background: #ecfdf5;
      border: 2px solid var(--brand);
      border-radius: 12px;
    }
    
    .success-banner .emoji {
      font-size: 56px;
      margin-bottom: 16px;
      display: block;
    }
    
    .success-banner h2 {
      color: var(--ink);
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .success-banner .note {
      margin-top: 8px;
      margin-bottom: 20px;
      color: var(--muted);
    }
    
    .success-banner .button {
      max-width: 280px;
      margin: 0 auto;
    }
    
    @keyframes fadein {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 13px;
    }
    
    .footer a {
      color: var(--muted);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .footer a:hover {
      color: var(--brand-600);
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 32px 24px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      .row {
        flex-direction: column;
      }
      
      .button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <main class="container">
      <h1>Reset Password</h1>
      <p id="lead" class="lead">Enter your email to receive a secure reset link.</p>

      <!-- PASSWORD FORM (shown when a token session is present) -->
      <form id="resetForm" class="hidden" autocomplete="off">
        <div class="form-group">
          <label for="password">New password</label>
          <input id="password" type="password" minlength="8" required placeholder="Enter new password" />
          <div class="requirements">
            <div class="requirement" id="req-length">✓ At least 8 characters</div>
            <div class="requirement" id="req-uppercase">✓ One uppercase letter</div>
            <div class="requirement" id="req-lowercase">✓ One lowercase letter</div>
            <div class="requirement" id="req-number">✓ One number</div>
            <div class="requirement" id="req-special">✓ One special character</div>
          </div>
        </div>
        <div class="form-group">
          <label for="confirm">Confirm password</label>
          <input id="confirm" type="password" minlength="8" required placeholder="Confirm new password" />
        </div>
        <div class="row">
          <button id="submitBtn" class="button btn-primary" type="submit">Set New Password</button>
          <button id="cancel" class="button btn-ghost" type="button">Clear</button>
        </div>
      </form>

      <!-- REQUEST-LINK FORM (shown when there is no token) -->
      <form id="requestForm" class="" autocomplete="off">
        <div class="form-group">
          <label for="email">Email address</label>
          <input id="email" type="email" required placeholder="you@example.com" />
          <div class="note">We'll email you a secure link to reset your password.</div>
        </div>
        <div class="row">
          <button id="requestBtn" class="button btn-primary" type="submit">Send Reset Link</button>
        </div>
      </form>

      <!-- MESSAGES -->
      <div id="msgOk" class="msg ok hidden"></div>
      <div id="msgErr" class="msg err hidden"></div>

      <!-- SUCCESS BANNER -->
      <div id="successBanner" class="msg ok hidden success-banner">
        <div class="emoji">✅</div>
        <h2>Password updated successfully!</h2>
        <div class="note">You can now sign in to PoCo with your new password.</div>
        <a href="aipocketcompanion://signin" class="button btn-primary">Open PoCo App</a>
        <div class="note" style="margin-top: 16px;">
          <a href="https://www.hellopoco.app" style="color: var(--brand-600);">Or visit hellopoco.app</a>
        </div>
      </div>
    </main>
  </div>

  <footer class="footer">
    © 2025 Pocket Companion •
    <a href="/privacy">Privacy</a> •
    <a href="/terms">Terms</a> •
    <a href="/support">Support</a>
  </footer>

  <!-- Load Supabase from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- Password reset logic -->
  <script>
    (async () => {
      // Initialize Supabase client
      const SUPABASE_URL = 'https://derggkmbocosxcxhnwvf.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcmdna21ib2Nvc3hjeGhud3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NzMzNDYsImV4cCI6MjA2ODM0OTM0Nn0.sF7LmxlL0NinnKJ_1RWpro9xXK8xn01uZjIme2EQ2P0';
      
      const { createClient } = window.supabase;
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Helper functions
      const $ = (id) => document.getElementById(id);
      const show = (el) => el && el.classList.remove('hidden');
      const hide = (el) => el && el.classList.add('hidden');
      const ok = (t) => { const el = $('msgOk'); el.textContent = t; show(el); hide($('msgErr')); };
      const err = (t) => { const el = $('msgErr'); el.textContent = t; show(el); hide($('msgOk')); };

      const lead = $('lead');
      const resetForm = $('resetForm');
      const requestForm = $('requestForm');
      const success = $('successBanner');
      const passwordInput = $('password');
      const confirmInput = $('confirm');

      // Password requirements for real-time validation
      const requirements = {
        length: { regex: /.{8,}/, element: $('req-length') },
        uppercase: { regex: /[A-Z]/, element: $('req-uppercase') },
        lowercase: { regex: /[a-z]/, element: $('req-lowercase') },
        number: { regex: /\d/, element: $('req-number') },
        special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: $('req-special') }
      };

      // Real-time password validation
      if (passwordInput) {
        passwordInput.addEventListener('input', function() {
          const password = this.value;
          for (const [key, req] of Object.entries(requirements)) {
            if (req.regex.test(password)) {
              req.element.classList.add('met');
            } else {
              req.element.classList.remove('met');
            }
          }
        });
      }

      const qs = new URLSearchParams(location.search);
      const frag = new URLSearchParams(location.hash.slice(1));

      // Check if URL has any recovery parameters
      function hasAnyRecoveryParams() {
        return !!(qs.get('code') ||
                  frag.get('access_token') ||
                  (qs.get('token_hash') && (qs.get('type') === 'recovery')));
      }

      // Establish session if tokens are present in URL
      async function establishSessionIfPresent() {
        // Path A: PKCE code in query
        const code = qs.get('code');
        const typeQ = qs.get('type');
        if (code && (!typeQ || typeQ === 'recovery')) {
          const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
          if (error) throw error;
          history.replaceState(null, '', '/reset-password');
          return true;
        }

        // Path B: Legacy hash tokens
        const typeH = frag.get('type');
        const at = frag.get('access_token');
        const rt = frag.get('refresh_token');
        if (typeH === 'recovery' && at && rt) {
          const { error } = await sb.auth.setSession({ access_token: at, refresh_token: rt });
          if (error) throw error;
          history.replaceState(null, '', '/reset-password');
          return true;
        }

        // Path C: token_hash in query
        const token_hash = qs.get('token_hash');
        const email = qs.get('email');
        const type = qs.get('type');
        if (token_hash && type === 'recovery' && email) {
          const { error } = await sb.auth.verifyOtp({ type: 'recovery', token_hash, email });
          if (error) throw error;
          history.replaceState(null, '', '/reset-password');
          return true;
        }

        return false;
      }

      // Initialize page - determine which form to show
      try {
        if (hasAnyRecoveryParams() && await establishSessionIfPresent()) {
          hide(requestForm);
          show(resetForm);
          lead.textContent = 'Enter your new password below.';
        } else {
          show(requestForm);
          hide(resetForm);
          lead.textContent = 'Enter your email to receive a secure reset link.';
        }
      } catch (e) {
        console.error('Session error:', e);
        err(e?.message || 'Could not verify reset link. Please request a new one.');
        show(requestForm);
        hide(resetForm);
      }

      // Handle request reset link form
      $('requestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hide($('msgOk')); hide($('msgErr'));
        
        const email = $('email').value.trim();
        if (!email) return err('Please enter your email address.');
        
        const btn = $('requestBtn');
        btn.disabled = true;
        btn.textContent = 'Sending...';
        
        const { error } = await sb.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://www.hellopoco.app/reset-password'
        });
        
        btn.disabled = false;
        btn.textContent = 'Send Reset Link';
        
        if (error) return err(error.message || 'Could not send reset email.');
        ok('✅ Check your email for a secure reset link. It will open this page with your session.');
      });

      // Handle password reset form
      $('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hide($('msgOk')); hide($('msgErr'));
        
        const p1 = passwordInput.value.trim();
        const p2 = confirmInput.value.trim();
        
        if (p1.length < 8) return err('Password must be at least 8 characters.');
        if (p1 !== p2) return err('Passwords do not match.');
        
        // Validate all requirements
        let allRequirementsMet = true;
        for (const req of Object.values(requirements)) {
          if (!req.regex.test(p1)) {
            allRequirementsMet = false;
            break;
          }
        }
        if (!allRequirementsMet) return err('Please ensure your password meets all requirements.');
        
        const btn = $('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        const { error } = await sb.auth.updateUser({ password: p1 });
        
        if (error) {
          btn.disabled = false;
          btn.textContent = 'Set New Password';
          return err(error.message || 'Failed to update password.');
        }
        
        // Success! Show banner
        hide(resetForm);
        hide($('msgErr'));
        hide($('msgOk'));
        show(success);
        
        console.log('✅ Password updated successfully!');
      });

      // Clear button
      $('cancel').onclick = () => {
        passwordInput.value = '';
        confirmInput.value = '';
        hide($('msgOk'));
        hide($('msgErr'));
      };
    })();
  </script>
</body>
</html>

