<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - PoCo</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 48px 32px;
      max-width: 500px;
      width: 100%;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: #10b981;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    
    h1 {
      color: #059669;
      font-size: 28px;
      margin-bottom: 16px;
      font-weight: 700;
      text-align: center;
    }
    
    .message {
      color: #374151;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input[type="password"]:focus {
      outline: none;
      border-color: #10b981;
    }
    
    .requirements {
      margin-top: 8px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .requirement {
      color: #6b7280;
      margin: 4px 0;
    }
    
    .requirement.met {
      color: #10b981;
    }
    
    .button {
      width: 100%;
      background: #10b981;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .button:hover:not(:disabled) {
      background: #059669;
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .success {
      background: #f0fdf4;
      border: 1px solid #a7f3d0;
      color: #065f46;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .footer {
      margin-top: 32px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }
    
    .footer a {
      color: #10b981;
      text-decoration: none;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ü§ñ</div>
    <h1>üîê Reset Your Password</h1>
    <p class="message">Enter your new password below to reset your PoCo account password.</p>
    
    <div id="errorMessage" class="error hidden"></div>
    <div id="successMessage" class="success hidden"></div>
    
    <form id="resetForm">
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password" required>
        <div class="requirements">
          <div class="requirement" id="req-length">‚úì At least 8 characters</div>
          <div class="requirement" id="req-uppercase">‚úì One uppercase letter</div>
          <div class="requirement" id="req-lowercase">‚úì One lowercase letter</div>
          <div class="requirement" id="req-number">‚úì One number</div>
          <div class="requirement" id="req-special">‚úì One special character (!@#$%^&*)</div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
      </div>
      
      <button type="submit" class="button" id="submitBtn">Set New Password</button>
    </form>
    
    <div class="footer">
      <p>¬© 2025 Pocket Companion</p>
      <p style="margin-top: 8px;">
        <a href="https://www.hellopoco.app">Home</a> ‚Ä¢
        <a href="https://www.hellopoco.app/#privacy">Privacy</a> ‚Ä¢
        <a href="https://www.hellopoco.app/#terms">Terms</a> ‚Ä¢
        <a href="https://www.hellopoco.app/#support">Support</a>
      </p>
    </div>
  </div>

  <script>
    // Initialize Supabase client - REPLACE THESE WITH YOUR ACTUAL VALUES
    const SUPABASE_URL = 'https://auth.hellopoco.app';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcmdna21ib2Nvc3hjeGhud3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NzMzNDYsImV4cCI6MjA2ODM0OTM0Nn0.sF7LmxlL0NinnKJ_1RWpro9xXK8xn01uZjIme2EQ2P0'; // Get from Supabase Dashboard ‚Üí Settings ‚Üí API
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const resetForm = document.getElementById('resetForm');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Password requirements
    const requirements = {
      length: { regex: /.{8,}/, element: document.getElementById('req-length') },
      uppercase: { regex: /[A-Z]/, element: document.getElementById('req-uppercase') },
      lowercase: { regex: /[a-z]/, element: document.getElementById('req-lowercase') },
      number: { regex: /\d/, element: document.getElementById('req-number') },
      special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: document.getElementById('req-special') }
    };
    
    // Validate password in real-time
    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      let allMet = true;
      
      for (const [key, req] of Object.entries(requirements)) {
        if (req.regex.test(password)) {
          req.element.classList.add('met');
        } else {
          req.element.classList.remove('met');
          allMet = false;
        }
      }
      
      return allMet;
    });
    
    // Check for tokens in URL on page load
    window.addEventListener('DOMContentLoaded', async function() {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const access_token = hashParams.get('access_token');
      const refresh_token = hashParams.get('refresh_token');
      const type = hashParams.get('type');
      const error = hashParams.get('error');
      const error_description = hashParams.get('error_description');
      
      if (error) {
        showError(error_description || error);
        submitBtn.disabled = true;
        return;
      }
      
      if (!access_token || !refresh_token) {
        showError('Invalid or expired reset link. Please request a new password reset.');
        submitBtn.disabled = true;
        return;
      }
      
      if (type !== 'recovery') {
        showError('Invalid reset link type. Please request a new password reset.');
        submitBtn.disabled = true;
        return;
      }
      
      // Set the session with the tokens
      try {
        const { error: sessionError } = await supabase.auth.setSession({
          access_token,
          refresh_token
        });
        
        if (sessionError) {
          showError('Failed to verify reset link: ' + sessionError.message);
          submitBtn.disabled = true;
        }
      } catch (err) {
        showError('An error occurred. Please try again.');
        submitBtn.disabled = true;
      }
    });
    
    // Handle form submission
    resetForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      hideMessages();
      
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showError('Passwords do not match. Please try again.');
        return;
      }
      
      // Validate all requirements
      let allRequirementsMet = true;
      for (const req of Object.values(requirements)) {
        if (!req.regex.test(newPassword)) {
          allRequirementsMet = false;
          break;
        }
      }
      
      if (!allRequirementsMet) {
        showError('Please ensure your password meets all requirements.');
        return;
      }
      
      // Update password
      submitBtn.disabled = true;
      submitBtn.textContent = 'Updating Password...';
      
      try {
        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });
        
        if (error) {
          showError('Failed to update password: ' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Set New Password';
          return;
        }
        
        // Success!
        showSuccess('Password updated successfully! You can now sign in with your new password.');
        resetForm.classList.add('hidden');
        
        // Redirect to app store or homepage after 3 seconds
        setTimeout(() => {
          window.location.href = 'https://www.hellopoco.app';
        }, 3000);
        
      } catch (err) {
        showError('An unexpected error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Set New Password';
      }
    });
    
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    
    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.remove('hidden');
    }
    
    function hideMessages() {
      errorMessage.classList.add('hidden');
      successMessage.classList.add('hidden');
    }
  </script>
</body>
</html>
