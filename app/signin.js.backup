import * as React from 'react';
import { View, Image, KeyboardAvoidingView, Platform, TouchableOpacity } from 'react-native';
import { TextInput, Button, Card, Text, Provider as PaperProvider } from 'react-native-paper';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useRouter } from 'expo-router';
import { supabase } from '../lib/supabase';

const DARK_GREEN = '#00B686';
const LIGHT_GREEN = '#1DE9B6';
const BG_GREEN = '#f0fdf4';

export default function SignInScreen() {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [message, setMessage] = React.useState('');
  const [rememberMe, setRememberMe] = React.useState(false);
  const router = useRouter();

  // Load saved email on component mount
  React.useEffect(() => {
    const loadSavedEmail = async () => {
      try {
        const savedEmail = await AsyncStorage.getItem('rememberedEmail');
        if (savedEmail) {
          setEmail(savedEmail);
          setRememberMe(true);
        }
      } catch (error) {
        console.log('Error loading saved email:', error);
      }
    };
    loadSavedEmail();
  }, []);

  const handleSignIn = async () => {
    if (!email || !password) {
      setMessage('Please enter both email and password.');
      return;
    }
    
    // Save email if remember me is checked
    if (rememberMe) {
      try {
        await AsyncStorage.setItem('rememberedEmail', email);
      } catch (error) {
        console.log('Error saving email:', error);
      }
    } else {
      try {
        await AsyncStorage.removeItem('rememberedEmail');
      } catch (error) {
        console.log('Error removing saved email:', error);
      }
    }
    
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) setMessage(error.message);
    else {
      setMessage('Signed in!');
      // Check if user is onboarded and navigate accordingly
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('first_name, companion_name')
          .eq('id', user.id);
        
        const isOnboarded = !!(profile && profile.length > 0 && profile[0].first_name && profile[0].companion_name);
        
        if (isOnboarded) {
          router.replace('/');
        } else {
          router.replace('/onboarding');
        }
      }
    }
  };

  const handleSignUp = async () => {
    if (!email || !password) {
      setMessage('Please enter both email and password.');
      return;
    }
    
    setMessage('Creating your account...');
    
    try {
      // For development - skip email confirmation
      const { data, error } = await supabase.auth.signUp({ 
        email, 
        password,
        options: {
          emailRedirectTo: 'http://localhost:8081'
        }
      });
      
      console.log('Signup result:', data);
      console.log('Signup error:', error);
      
      if (error) {
        setMessage(error.message);
      } else if (data.user) {
        console.log('User created successfully:', data.user.id);
        
        // For development - proceed immediately without email confirmation
        setMessage('Account created! Redirecting to onboarding...');
        setTimeout(() => {
          router.replace('/onboarding');
        }, 1000);
      } else {
        setMessage('Account creation failed. Please try again.');
      }
    } catch (error) {
      console.error('Signup error:', error);
      setMessage('An error occurred during signup. Please try again.');
    }
  };

  const getMessageColor = () => {
    if (!message) return 'black';
    const msg = message.toLowerCase();
    if (msg.includes('error') || msg.includes('invalid') || msg.includes('fail')) return 'red';
    return DARK_GREEN;
  };

  return (
    <PaperProvider>
      <KeyboardAvoidingView
        style={{ flex: 1, backgroundColor: BG_GREEN }}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        keyboardVerticalOffset={60}
      >
        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
          <Card style={{
            width: '90%',
            maxWidth: 400,
            padding: 20,
            borderRadius: 20,
            elevation: 8,
            backgroundColor: 'white',
            shadowColor: '#000',
            borderWidth: 2,
            borderColor: DARK_GREEN,
          }}>
            <View style={{ alignItems: 'center', marginBottom: 12 }}>
              <Image
                source={require('../assets/poco-logo.png')}
                style={{ width: 100, height: 100, resizeMode: 'contain', marginBottom: 8 }}
              />
              <Text style={{
                color: DARK_GREEN,
                fontWeight: 'bold',
                fontSize: 28,
                textAlign: 'center',
                letterSpacing: 2,
                marginBottom: 4
              }}>
                Pocket Companion
              </Text>
            </View>
            <Card.Content>
              <Text style={{ textAlign: 'center', marginBottom: 16, color: '#333', fontSize: 16 }}>
                Sign in to your account
              </Text>
              <TextInput
                label="Email"
                value={email}
                onChangeText={setEmail}
                autoCapitalize="none"
                keyboardType="email-address"
                style={{ marginBottom: 12, backgroundColor: 'white' }}
              />
              <TextInput
                label="Password"
                value={password}
                onChangeText={setPassword}
                secureTextEntry
                style={{ marginBottom: 12, backgroundColor: 'white' }}
              />
              <Text style={{ fontSize: 12, color: "#666", marginBottom: 8, textAlign: "center" }}>
                Password must be at least 6 characters long
              </Text>              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 16 }}>
                <TouchableOpacity
                  onPress={() => setRememberMe(!rememberMe)}
                  style={{
                    width: 20,
                    height: 20,
                    borderWidth: 2,
                    borderColor: DARK_GREEN,
                    borderRadius: 4,
                    marginRight: 8,
                    backgroundColor: rememberMe ? DARK_GREEN : '#fff',
                    justifyContent: 'center',
                    alignItems: 'center',
                  }}
                >
                  {rememberMe && (
                    <View
                      style={{
                        width: 8,
                        height: 8,
                        backgroundColor: '#fff',
                        borderRadius: 2,
                      }}
                    />
                  )}
                </TouchableOpacity>
                <Text style={{ color: '#333', fontSize: 14 }}>
                  Remember my email
                </Text>
              </View>
              <Button
                mode="contained"
                onPress={handleSignIn}
                style={{ marginBottom: 10, backgroundColor: LIGHT_GREEN }}
                labelStyle={{ fontWeight: 'bold', color: '#00332e' }}
              >
                Sign In
              </Button>
              <Button
                mode="contained"
                onPress={handleSignUp}
                style={{ backgroundColor: DARK_GREEN }}
                labelStyle={{ fontWeight: 'bold', color: 'white' }}
              >
                Sign Up
              </Button>
              {message ? (
                <Text style={{
                  marginTop: 16,
                  color: getMessageColor(),
                  textAlign: 'center'
                }}>
                  {message}
                </Text>
              ) : null}
            </Card.Content>
          </Card>
        </View>
      </KeyboardAvoidingView>
    </PaperProvider>
  );
}
